# 跟单系统授权系统使用说明

## 新增功能概述

跟单系统新增了基于JWT和TOTP双因素认证的授权系统，提供了更安全的访问控制机制。新系统特点：

1. **双因素认证**：用户名密码 + TOTP动态验证码
2. **JWT令牌认证**：所有API请求自动携带认证令牌
3. **自动令牌续期**：长时间操作无需频繁登录
4. **安全退出机制**：可随时安全登出系统

## 登录流程

1. 访问系统时会自动跳转到登录页面
2. 输入用户名和密码
3. 首次登录时，扫描TOTP二维码，设置验证器
4. 输入验证器生成的6位动态验证码
5. 验证通过后自动跳转到系统主页

## 使用方法

### 首次登录

1. 访问系统URL，自动跳转到登录页面
2. 输入管理员提供的用户名和密码
3. 系统显示二维码，使用以下任一TOTP应用扫描：
   - Google Authenticator
   - Microsoft Authenticator
   - Authy
   - 1Password
4. 输入应用生成的6位验证码
5. 验证成功后，系统将自动跳转到主页

### 日常登录

1. 访问系统URL，自动跳转到登录页面
2. 输入用户名和密码
3. 输入TOTP验证器生成的6位验证码
4. 登录成功后自动跳转到主页

### 安全退出

点击界面右上角或左侧导航栏底部的"退出"按钮安全退出系统。

## 技术实现细节

### 前端实现

1. **授权上下文**：使用React Context API管理认证状态
2. **JWT存储**：令牌安全存储在localStorage，并自动添加到API请求头
3. **路由保护**：使用ProtectedRoute组件保护需要认证的路由
4. **自动登出**：令牌过期后自动登出系统

### 后端API接口

1. `/auth/login`: 用户名密码登录，返回临时令牌
2. `/auth/verify`: TOTP验证码验证，返回JWT令牌
3. `/auth/totp-qr/{username}`: 获取TOTP配置二维码URL
4. `/auth/totp-qr-image/{username}`: 获取TOTP配置二维码图片

## 常见问题

1. **验证码错误**：请确认设备时间是否准确，TOTP依赖精确的时间同步
2. **更换设备**：请提前备份TOTP种子密钥，或联系管理员重置
3. **令牌过期**：JWT令牌有效期为24小时，过期后需要重新登录

## 注意事项

1. 请妥善保管TOTP种子密钥，避免丢失
2. 不要与他人分享验证器应用或截图
3. 确保使用安全设备访问系统
4. 操作完成后请点击"退出登录"按钮安全退出系统 